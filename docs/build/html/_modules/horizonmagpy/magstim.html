

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>horizonmagpy.magstim &mdash; magstim stimulators 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> magstim stimulators
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../description.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizonmagpy.horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizonmagpy.magstim.html">Magstim (parent class)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../test.html">Example code</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">magstim stimulators</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>horizonmagpy.magstim</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for horizonmagpy.magstim</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span><span class="p">,</span> <span class="n">platform</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">realpath</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">dirname</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">getcwd</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">floor</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">yaml</span> <span class="kn">import</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

<span class="c1"># Switch timer based on python version and platform</span>
<span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
    <span class="c1"># In python </span>
    <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
    <span class="n">defaultTimer</span> <span class="o">=</span> <span class="n">perf_counter</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
        <span class="c1"># On Windows, use time.clock</span>
        <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">clock</span>
        <span class="n">defaultTimer</span> <span class="o">=</span> <span class="n">clock</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># On other platforms use time.time</span>
        <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>    
        <span class="n">defaultTimer</span> <span class="o">=</span> <span class="n">time</span>

<span class="c1"># Calculate checksum for command</span>
<span class="k">if</span> <span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
    <span class="k">def</span> <span class="nf">calcCRC</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the CRC checksum for the command string.&quot;&quot;&quot;</span>
        <span class="c1"># Convert command string to sum of ASCII/byte values</span>
        <span class="n">commandSum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="c1"># Convert command sum to binary, then invert and return 8-bit character value</span>
        <span class="k">return</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="o">~</span><span class="n">commandSum</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin_1&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">calcCRC</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the CRC checksum for the command string.&quot;&quot;&quot;</span>
        <span class="c1"># Convert command string to sum of ASCII/byte values</span>
        <span class="n">commandSum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="c1"># Convert command sum to binary, then invert and return 8-bit character value</span>
        <span class="k">return</span> <span class="nb">chr</span><span class="p">(</span><span class="o">~</span><span class="n">commandSum</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MagstimError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">serialPortController</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The class creates a Python process which has direct control of the serial port. Commands for relaying via the serial port are received from separate Python processes via Queues.</span>
<span class="sd">    </span>
<span class="sd">    N.B. To start the process you must call start() from the parent Python process.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">    serialWriteQueue (multiprocessing.Queue): a Queue for receiving commands to be written to the Magstim unit via the serial port</span>
<span class="sd">    serialReadQueue (multiprocessing.Queue): a Queue for returning automated replies from the Magstim unit when requested</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Error codes</span>
    <span class="n">SERIAL_WRITE_ERR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;SERIAL_WRITE_ERR: Could not send the command.&#39;</span><span class="p">)</span>
    <span class="n">SERIAL_READ_ERR</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;SERIAL_READ_ERR:  Could not read the magstim response.&#39;</span><span class="p">)</span>    
   
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialConnection</span><span class="p">,</span> <span class="n">serialWriteQueue</span><span class="p">,</span> <span class="n">serialReadQueue</span><span class="p">):</span>
        <span class="n">Process</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serialWriteQueue</span> <span class="o">=</span> <span class="n">serialWriteQueue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serialReadQueue</span> <span class="o">=</span> <span class="n">serialReadQueue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_address</span> <span class="o">=</span> <span class="n">serialConnection</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Continuously monitor the serialWriteQueue for commands from other Python processes to be sent to the Magstim.</span>
<span class="sd">        </span>
<span class="sd">        When requested, will return the automated reply from the Magstim unit to the calling process via the serialReadQueue.</span>
<span class="sd">        </span>
<span class="sd">        N.B. This should be called via start() from the parent Python process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># N.B. most of these settings are actually the default in PySerial, but just being careful.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_address</span><span class="p">,</span>
                                   <span class="n">baudrate</span><span class="o">=</span><span class="mi">9600</span><span class="p">,</span>
                                   <span class="n">bytesize</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">EIGHTBITS</span><span class="p">,</span>
                                   <span class="n">stopbits</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">STOPBITS_ONE</span><span class="p">,</span>
                                   <span class="n">parity</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">PARITY_NONE</span><span class="p">,</span>
                                   <span class="n">xonxoff</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Make sure the RTS pin is set to off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">setRTS</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Set up version compatibility</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">serial</span><span class="o">.</span><span class="n">VERSION</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">write_timeout</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">portFlush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">reset_input_buffer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">anyWaiting</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">in_waiting</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">writeTimeout</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">portFlush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">flushInput</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">anyWaiting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">inWaiting</span>
        <span class="c1"># This continually monitors the serialWriteQueue for write requests</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">readBytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialWriteQueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If the first part of the message is None this signals the process to close the port and stop</span>
                <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="c1"># If the first part of the message is a 1 this signals the process to trigger a quick fire using the RTS pin</span>
                <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">setRTS</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># If the first part of the message is a -1 this signals the process to reset the RTS pin</span>
                <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>                
                    <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">setRTS</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># Otherwise, the message is a command string</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># There shouldn&#39;t be any rubbish in the input buffer, but check and clear it just in case</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">anyWaiting</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">portFlush</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Try writing to the port</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                        <span class="c1"># Read response (this gets a little confusing, as I don&#39;t want to rely on timeout to know if there&#39;s an error)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Read the first byte</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                            <span class="c1"># If the first returned byte is a &#39;N&#39;, we need to read the version number in one byte at a time to catch the string terminator.</span>
                            <span class="k">if</span> <span class="n">message</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;N&#39;</span><span class="p">:</span>
                                <span class="k">while</span> <span class="n">message</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">message</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                <span class="c1"># After the end of the version number, read one more byte to grab the CRC</span>
                                <span class="n">message</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="c1"># If the first byte is not &#39;?&#39;, then the message was understood so carry on reading in the response (if it was a &#39;?&#39;, then this will be the only returned byte).</span>
                            <span class="k">elif</span> <span class="n">message</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;?&#39;</span><span class="p">:</span>
                                <span class="c1"># Read the second byte</span>
                                <span class="n">message</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                <span class="c1"># If the second returned byte is a &#39;?&#39; or &#39;S&#39;, then the data value supplied either wasn&#39;t acceptable (&#39;?&#39;) or the command conflicted with the current settings (&#39;S&#39;),</span>
                                <span class="c1"># In these cases, just grab the CRC - otherwise, everything is ok so carry on reading the rest of the message</span>
                                <span class="n">message</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">readBytes</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">83</span><span class="p">,</span> <span class="mi">63</span><span class="p">}</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="c1"># Return the reply if we want it</span>
                            <span class="k">if</span> <span class="n">reply</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_serialReadQueue</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1">#serial.SerialException:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_serialReadQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">serialPortController</span><span class="o">.</span><span class="n">SERIAL_READ_ERR</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1">#serial.SerialException:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_serialReadQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">serialPortController</span><span class="o">.</span><span class="n">SERIAL_WRITE_ERR</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="c1">#If we get here, it&#39;s time to shutdown the serial port controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>

<span class="k">class</span> <span class="nc">connectionRobot</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The class creates a Python process which sends an &#39;enable remote control&#39; command to the Magstim via the serialPortController process every 500ms.</span>
<span class="sd">    </span>
<span class="sd">    N.B. To start the process you must call start() from the parent Python process.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">    serialWriteQueue (multiprocessing.Queue): a Queue for sending commands to be written to the Magstim unit via the serialPortController process</span>
<span class="sd">    updateTimeQueue (multiprocessing.Queue): a Queue for receiving requests from the parent Python process to delay sending its next command</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialWriteQueue</span><span class="p">,</span> <span class="n">updateRobotQueue</span><span class="p">):</span>
        <span class="n">Process</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serialWriteQueue</span> <span class="o">=</span> <span class="n">serialWriteQueue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateRobotQueue</span> <span class="o">=</span> <span class="n">updateRobotQueue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paused</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nextPokeTime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connectionCommand</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_setCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connectionCommand</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connectionCommand</span> <span class="o">=</span> <span class="n">connectionCommand</span>
        
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Continuously send commands to the serialPortController process at regular intervals, while also monitoring the updateTimeQueue for commands from the parent Python process if this should be delayed, paused, or stopped.</span>
<span class="sd">        </span>
<span class="sd">        N.B. This should be called via start() from the parent Python process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This sends an &quot;enable remote control&quot; command to the serial port controller every 500ms (if armed) or 5000 ms (if disarmed); only runs once the stimulator is armed</span>
        <span class="n">pokeLatency</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># If the robot is currently paused, wait until we get a None (stop) or a non-negative number (start/resume) in the queue</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paused</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updateRobotQueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_paused</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">message</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># If message is a 2, that means we&#39;ve just armed so speed up the poke latency (not sure that&#39;s possible while paused, but just in case)</span>
                    <span class="k">if</span> <span class="n">message</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">pokeLatency</span> <span class="o">=</span> <span class="mf">0.5</span>
                    <span class="c1"># If message is a 1, that means we&#39;ve just disarmed so slow down the poke latency</span>
                    <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">pokeLatency</span> <span class="o">=</span> <span class="mi">5</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_paused</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Check if we&#39;re stopping the robot</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># Update next poll time to the next poke latency</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nextPokeTime</span> <span class="o">=</span> <span class="n">defaultTimer</span><span class="p">()</span> <span class="o">+</span> <span class="n">pokeLatency</span>
            <span class="c1"># While waiting for next poll...</span>
            <span class="k">while</span> <span class="n">defaultTimer</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nextPokeTime</span><span class="p">:</span>
                <span class="c1"># ...check to see if there has been an update send from the parent magstim object</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updateRobotQueue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updateRobotQueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="c1"># If the message is None this signals the process to stop</span>
                    <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># If the message is -1, we&#39;ve relinquished remote control so signal the process to pause</span>
                    <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">pokeLatency</span> <span class="o">=</span> <span class="mi">5</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_paused</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Any other message signals a command has been sent to the serial port controller</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If message is a 2, that means we&#39;ve just armed so speed up the poke latency (not sure that&#39;s possible while paused, but just in case)</span>
                        <span class="k">if</span> <span class="n">message</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">pokeLatency</span> <span class="o">=</span> <span class="mf">0.5</span>
                        <span class="c1"># If message is a 1, that means we&#39;ve just disarmed so slow down the poke latency</span>
                        <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">pokeLatency</span> <span class="o">=</span> <span class="mi">5</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_nextPokeTime</span> <span class="o">=</span> <span class="n">defaultTimer</span><span class="p">()</span> <span class="o">+</span> <span class="n">pokeLatency</span>
                    <span class="k">break</span>
            <span class="c1"># If we made it all the way to the next poll time, send a poll to the port controller</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_serialWriteQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connectionCommand</span><span class="p">)</span>
        <span class="c1"># If we get here, it&#39;s time to shutdown the robot</span>
        <span class="k">return</span>
        
<div class="viewcode-block" id="Magstim"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim">[docs]</a><span class="k">class</span> <span class="nc">Magstim</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base Magstim class. This is used for controlling 200^2 Magstim units, and acts as a parent class for the BiStim^2 and Rapid^2 sub-classes.</span>
<span class="sd">    </span>
<span class="sd">    It also creates two additional Python processes; one for the purposes of directly controlling the serial port and another for maintaining constant contact with the Magstim.</span>
<span class="sd">    </span>
<span class="sd">    N.B. This class can effect limited control over BiStim^2 and Rapid^2 units, however some functionality will not be able to be accessed and return values (including confirmation of commands) may be invalid.</span>
<span class="sd">    </span>
<span class="sd">         To begin sending commands to the Magstim, and start the additional Python processes, you must first call connect().</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">    serialConnection (str): The address of the serial port. On Windows this is typically &#39;COM1&#39; or similar. To create a virtual magstim, set the address to &#39;virtual&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Hardware error codes (for all types of stimulators)</span>
    <span class="n">INVALID_COMMAND_ERR</span>       <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="s1">&#39;INVALID_COMMAND_ERR: Invalid command sent.&#39;</span><span class="p">)</span>
    <span class="n">INVALID_DATA_ERR</span>          <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span>  <span class="s1">&#39;INVALID_DATA_ERR: Invalid data provided.&#39;</span><span class="p">)</span>
    <span class="n">COMMAND_CONFLICT_ERR</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span>  <span class="s1">&#39;COMMAND_CONFLICT_ERR: Command conflicts with current system configuration.&#39;</span><span class="p">)</span>
    <span class="n">INVALID_CONFIRMATION_ERR</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span>  <span class="s1">&#39;INVALID_CONFIRMATION_ERR: Unexpected command confirmation received.&#39;</span><span class="p">)</span>
    <span class="n">CRC_MISMATCH_ERR</span>          <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span>  <span class="s1">&#39;CRC_MISMATCH_ERR: Message contents and CRC value do not match.&#39;</span><span class="p">)</span>
    <span class="n">NO_REMOTE_CONTROL_ERR</span>     <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span>  <span class="s1">&#39;NO_REMOTE_CONTROL_ERR: You have not established control of the Magstim unit.&#39;</span><span class="p">)</span>
    <span class="n">PARAMETER_ACQUISTION_ERR</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span>  <span class="s1">&#39;PARAMETER_ACQUISTION_ERR: Could not obtain prior parameter settings.&#39;</span><span class="p">)</span>
    <span class="n">PARAMETER_UPDATE_ERR</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;PARAMETER_UPDATE_ERR: Could not update secondary parameter to accommodate primary parameter change.&#39;</span><span class="p">)</span>
    <span class="n">PARAMETER_FLOAT_ERR</span>       <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;PARAMETER_FLOAT_ERR: A float value is not allowed for this parameter.&#39;</span><span class="p">)</span>
    <span class="n">PARAMETER_PRECISION_ERR</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;PARAMETER_PRECISION_ERR: Only one decimal placed allowed for this parameter.&#39;</span><span class="p">)</span>
    <span class="n">PARAMETER_RANGE_ERR</span>       <span class="o">=</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;PARAMETER_RANGE_ERR: Parameter value is outside the allowed range.&#39;</span><span class="p">)</span>
    <span class="n">GET_SYSTEM_STATUS_ERR</span>     <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;GET_SYSTEM_STATUS_ERR: Cannot call getSystemStatus() until software version has been established.&#39;</span><span class="p">)</span>
    <span class="n">SYSTEM_STATUS_VERSION_ERR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;SYSTEM_STATUS_VERSION_ERR: Method getSystemStatus() is not compatible with your software version.&#39;</span><span class="p">)</span>
    <span class="n">SEQUENCE_VALIDATION_ERR</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;SEQUENCE_VALIDATION_ERR: You must call validateSequence() before you can run a rTMS train.&#39;</span><span class="p">)</span>
    <span class="n">MIN_WAIT_TIME_ERR</span>         <span class="o">=</span> <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;MIN_WAIT_TIME_ERR: Minimum wait time between trains violated. Call isReadyToFire() to check.&#39;</span><span class="p">)</span>
    <span class="n">MAX_ON_TIME_ERR</span>           <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;MAX_ON_TIME_ERR: Maximum on time exceeded for current train.&#39;</span><span class="p">)</span>
    
<div class="viewcode-block" id="Magstim.parseMagstimResponse"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.parseMagstimResponse">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parseMagstimResponse</span><span class="p">(</span><span class="n">responseString</span><span class="p">,</span> <span class="n">responseType</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Interprets responses sent from the Magstim unit.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">responseType</span> <span class="o">==</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span>
            <span class="c1">#magstimResponse = tuple(int(x) for x in bytes(responseString[1:-1]).strip().split(b&#39;.&#39;) if x.isdigit())</span>
            <span class="n">magstimResponse</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get ASCII code of first data character</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">responseString</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Interpret bits</span>
            <span class="n">magstimResponse</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;instr&#39;</span><span class="p">:{</span><span class="s1">&#39;standby&#39;</span><span class="p">:</span>       <span class="n">temp</span> <span class="o">&amp;</span>   <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;armed&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;ready&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;coilPresent&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;replaceCoil&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;errorPresent&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;errorType&#39;</span><span class="p">:</span>    <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;remoteStatus&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">}}</span>
    
        <span class="c1"># If a Rapid system and response includes rTMS status     </span>
        <span class="k">if</span> <span class="n">responseType</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;instrRapid&#39;</span><span class="p">,</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">,</span><span class="s1">&#39;systemRapid&#39;</span><span class="p">}:</span>
            <span class="c1"># Get ASCII code of second data character        </span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">responseString</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Interpret bits</span>
            <span class="n">magstimResponse</span><span class="p">[</span><span class="s1">&#39;rapid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;enhancedPowerMode&#39;</span><span class="p">:</span>      <span class="n">temp</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;train&#39;</span><span class="p">:</span>                 <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;wait&#39;</span><span class="p">:</span>                  <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;singlePulseMode&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;hvpsuConnected&#39;</span><span class="p">:</span>        <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;coilReady&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;thetaPSUDetected&#39;</span><span class="p">:</span>      <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="s1">&#39;modifiedCoilAlgorithm&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">}</span>
    
        <span class="c1"># If requesting parameter settings or coil temperature</span>
        <span class="k">if</span> <span class="n">responseType</span> <span class="o">==</span> <span class="s1">&#39;bistimParam&#39;</span><span class="p">:</span>
            <span class="n">magstimResponse</span><span class="p">[</span><span class="s1">&#39;bistimParam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;powerA&#39;</span><span class="p">:</span>   <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])),</span>
                                              <span class="s1">&#39;powerB&#39;</span><span class="p">:</span>   <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])),</span>
                                              <span class="s1">&#39;ppOffset&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]))}</span>
    
        <span class="k">elif</span> <span class="n">responseType</span> <span class="o">==</span> <span class="s1">&#39;magstimParam&#39;</span><span class="p">:</span>
            <span class="n">magstimResponse</span><span class="p">[</span><span class="s1">&#39;magstimParam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))}</span>
    
        <span class="k">elif</span> <span class="n">responseType</span> <span class="ow">in</span> <span class="s1">&#39;rapidParam&#39;</span><span class="p">:</span>
            <span class="c1"># This is a bit of a hack to determine which software version we&#39;re dealing with</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">responseString</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">magstimResponse</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;power&#39;</span><span class="p">:</span>     <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])),</span>
                                                 <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span>
                                                 <span class="s1">&#39;nPulses&#39;</span><span class="p">:</span>   <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">])),</span>
                                                 <span class="s1">&#39;duration&#39;</span><span class="p">:</span>  <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span>
                                                 <span class="s1">&#39;wait&#39;</span><span class="p">:</span>      <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">16</span><span class="p">:]))</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">magstimResponse</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;power&#39;</span><span class="p">:</span>     <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])),</span>
                                                 <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span>
                                                 <span class="s1">&#39;nPulses&#39;</span><span class="p">:</span>   <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">11</span><span class="p">])),</span>
                                                 <span class="s1">&#39;duration&#39;</span><span class="p">:</span>  <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">14</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span>
                                                 <span class="s1">&#39;wait&#39;</span><span class="p">:</span>      <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">14</span><span class="p">:]))</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">}</span>
    
        <span class="k">elif</span> <span class="n">responseType</span> <span class="o">==</span> <span class="s1">&#39;magstimTemp&#39;</span><span class="p">:</span>
            <span class="n">magstimResponse</span><span class="p">[</span><span class="s1">&#39;magstimTemp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;coil1Temp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span>
                                              <span class="s1">&#39;coil2Temp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">}</span>

        <span class="k">elif</span> <span class="n">responseType</span> <span class="o">==</span> <span class="s1">&#39;systemRapid&#39;</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">responseString</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">magstimResponse</span><span class="p">[</span><span class="s1">&#39;extInstr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;plus1ModuleDetected&#39;</span><span class="p">:</span>       <span class="n">temp</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                           <span class="s1">&#39;specialTriggerModeActive&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span>
                                           <span class="s1">&#39;chargeDelaySet&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">}</span>

        <span class="k">elif</span> <span class="n">responseType</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
            <span class="n">magstimResponse</span><span class="p">[</span><span class="s1">&#39;currentErrorCode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">responseType</span> <span class="o">==</span> <span class="s1">&#39;instrCharge&#39;</span><span class="p">:</span>
             <span class="n">magstimResponse</span><span class="p">[</span><span class="s1">&#39;chargeDelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">responseString</span><span class="p">))</span>
             
        <span class="k">return</span> <span class="n">magstimResponse</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialConnection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendQueue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_receiveQueue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setupSerialPort</span><span class="p">(</span><span class="n">serialConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_robotQueue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span> <span class="o">=</span> <span class="n">connectionRobot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sendQueue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robotQueue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connectionCommand</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Q@n&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queryCommand</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteControl</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_setupSerialPort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialConnection</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">serialConnection</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;virtual&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">_virtual</span> <span class="kn">import</span> <span class="n">virtualPortController</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">virtualPortController</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_sendQueue</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_receiveQueue</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">serialPortController</span><span class="p">(</span><span class="n">serialConnection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sendQueue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receiveQueue</span><span class="p">)</span>
    
<div class="viewcode-block" id="Magstim.connect"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Connect to the Magstim.</span>
<span class="sd">        </span>
<span class="sd">        This starts the serial port controller, as well as a process that constantly keeps in contact with the Magstim so as not to lose control.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteControl</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">_setCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connectionCommand</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sendQueue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">MagstimError</span><span class="p">(</span><span class="s1">&#39;Could not establish remote control over the Magstim.&#39;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Magstim.disconnect"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Disconnect from the Magstim.</span>
<span class="sd">        </span>
<span class="sd">        This stops maintaining contact with the Magstim and turns the serial port controller off.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disarm</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_robotQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteControl</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_robotQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendQueue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">False</span></div>
    
    <span class="k">def</span> <span class="nf">_processCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commandString</span><span class="p">,</span> <span class="n">receiptType</span><span class="p">,</span> <span class="n">readBytes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process Magstim command.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        commandString (str): command and data characters making up the command string (N.B. do not include CRC character)</span>
<span class="sd">        reciptType (bool): whether to return the occurrence of any error when executing the command and the automated response from the Magstim unit</span>
<span class="sd">        readBytes (int): number of bytes in the response</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receiptType argument is not None:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing one or more Magstim parameter dicts, otherwise returns an error string</span>
<span class="sd">        If receiptType argument is None:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Unify Python 2 and 3 strings</span>
        <span class="n">commandString</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">commandString</span><span class="p">)</span>
        <span class="c1"># Only process command if toggling remote control, querying parameters, or disarming, or otherwise only if connected to the Magstim</span>
        <span class="c1"># N.B. For Rapid stimulators, we first need to have established what version number we are (which sets _parameterReturnBytes) before we can query parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="ow">or</span> <span class="p">(</span><span class="n">commandString</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">81</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">70</span><span class="p">})</span> <span class="ow">or</span> <span class="n">commandString</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;EA&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">commandString</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">92</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameterReturnBytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Put command in the send queue to the serial port controller along with what kind of reply is requested and how many bytes to read back from the Magstim</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendQueue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="nb">bytes</span><span class="p">(</span><span class="n">commandString</span> <span class="o">+</span> <span class="n">calcCRC</span><span class="p">(</span><span class="n">commandString</span><span class="p">)),</span> <span class="n">receiptType</span><span class="p">,</span> <span class="n">readBytes</span><span class="p">))</span>
            <span class="c1"># If expecting a response, start inspecting the receive queue back from the serial port controller</span>
            <span class="k">if</span> <span class="n">receiptType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">error</span><span class="p">,</span> <span class="n">reply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receiveQueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="c1"># If error is true, that means we either couldn&#39;t send the command or didn&#39;t get anything back from the Magstim</span>
                <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">reply</span><span class="p">)</span>
                <span class="c1"># If we did get something back from the Magstim, parse the message and the return it</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Check for error messages</span>
                    <span class="k">if</span> <span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">63</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">INVALID_COMMAND_ERR</span>
                    <span class="k">elif</span> <span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">63</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">INVALID_DATA_ERR</span>
                    <span class="k">elif</span> <span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">83</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">COMMAND_CONFLICT_ERR</span>
                    <span class="k">elif</span> <span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">commandString</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">INVALID_CONFIRMATION_ERR</span>
                    <span class="k">elif</span> <span class="nb">ord</span><span class="p">(</span><span class="n">calcCRC</span><span class="p">(</span><span class="n">reply</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">!=</span> <span class="n">reply</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">CRC_MISMATCH_ERR</span>
            <span class="c1"># If we haven&#39;t returned yet, we got a valid message; so update the connection robot if we&#39;re connected</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">commandString</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;EA&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_robotQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">commandString</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;EB&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_robotQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_robotQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Then return the parsed response if requested</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">parseMagstimResponse</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">receiptType</span><span class="p">)</span> <span class="k">if</span> <span class="n">receiptType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">NO_REMOTE_CONTROL_ERR</span>
    
<div class="viewcode-block" id="Magstim.remoteControl"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.remoteControl">[docs]</a>    <span class="k">def</span> <span class="nf">remoteControl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Enable/Disable remote control of stimulator. Disabling remote control will first disarm the Magstim unit.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        enable (bool): whether to enable (True) or disable (False) control</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Magstim unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a Magstim instrument status [&#39;instr&#39;] dict, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Q@&#39;</span> <span class="k">if</span> <span class="n">enable</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;R@&#39;</span><span class="p">,</span> <span class="s1">&#39;instr&#39;</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Magstim.getParameters"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.getParameters">[docs]</a>    <span class="k">def</span> <span class="nf">getParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Request current parameter settings from the Magstim.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        :tuple:(error,message):</span>
<span class="sd">            error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">            message (dict,str): if error is 0 (False) returns a dict containing Magstim instrument status [&#39;instr&#39;] and parameter setting [&#39;magstimParam&#39;] dicts, otherwise returns an error string         </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;J@&#39;</span><span class="p">,</span> <span class="s1">&#39;magstimParam&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Magstim.setPower"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.setPower">[docs]</a>    <span class="k">def</span> <span class="nf">setPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newPower</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_commandByte</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;@&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set power level for Magstim.</span>
<span class="sd">        </span>
<span class="sd">        N.B. Allow 100 ms per unit drop in power, or 10 ms per unit increase in power.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        newPower (int): new power level (0-100)</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Magstim unit (defaults to False)</span>
<span class="sd">        delay (bool): enforce delay to allow Magstim time to change Power (defaults to False)</span>
<span class="sd">        _commandByte should not be changed by the user</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a Magstim instrument status [&#39;instr&#39;] dict, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure we have a valid power value</span>
        <span class="k">if</span> <span class="n">newPower</span> <span class="o">%</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_FLOAT_ERR</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">newPower</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_RANGE_ERR</span>

        <span class="c1">#If enforcing power change delay, grab current parameters</span>
        <span class="k">if</span> <span class="n">delay</span><span class="p">:</span>
            <span class="n">error</span><span class="p">,</span> <span class="n">priorPower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_ACQUISTION_ERR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Switch keys depending on whether we&#39;re returning for a BiStim</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;BiStim&#39;</span><span class="p">:</span>
                    <span class="n">priorPower</span> <span class="o">=</span> <span class="n">priorPower</span><span class="p">[</span><span class="s1">&#39;bistimParam&#39;</span><span class="p">][</span><span class="s1">&#39;powerA&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">_commandByte</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;@&#39;</span> <span class="k">else</span> <span class="n">priorPower</span><span class="p">[</span><span class="s1">&#39;bistimParam&#39;</span><span class="p">][</span><span class="s1">&#39;powerB&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Rapid&#39;</span><span class="p">:</span>
                    <span class="n">priorPower</span> <span class="o">=</span> <span class="n">priorPower</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;power&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">priorPower</span> <span class="o">=</span> <span class="n">priorPower</span><span class="p">[</span><span class="s1">&#39;magstimParam&#39;</span><span class="p">][</span><span class="s1">&#39;power&#39;</span><span class="p">]</span>
        
        <span class="n">error</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="n">_commandByte</span> <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">newPower</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="s1">&#39;instr&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">receipt</span> <span class="ow">or</span> <span class="n">delay</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="c1"># If we&#39;re meant to delay (and we were able to change the power), then enforce if prior power settings are available</span>
        <span class="k">if</span> <span class="n">delay</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">newPower</span> <span class="o">&gt;</span> <span class="n">priorPower</span><span class="p">:</span>
                    <span class="n">sleep</span><span class="p">((</span><span class="n">newPower</span> <span class="o">-</span> <span class="n">priorPower</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sleep</span><span class="p">((</span><span class="n">priorPower</span> <span class="o">-</span> <span class="n">newPower</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_UPDATE_ERR</span>
            
        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="Magstim.getTemperature"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.getTemperature">[docs]</a>    <span class="k">def</span> <span class="nf">getTemperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Request current coil temperature from the Magstim.</span>
<span class="sd">        </span>
<span class="sd">        N.B. Coil1 and Coil2 refer to the separate windings in a single figure-8 coil connected to the Magstim.</span>
<span class="sd">        </span>
<span class="sd">             Magstim units will automatically disarm (and cannot be armed) if the coil temperature exceeds 40 degrees celsius.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing Magstim instrument status [&#39;instr&#39;] and coil temperature [&#39;magstimTemp&#39;] dicts, otherwise returns an error string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;F@&#39;</span><span class="p">,</span> <span class="s1">&#39;magstimTemp&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>        </div>
    
<div class="viewcode-block" id="Magstim.poke"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.poke">[docs]</a>    <span class="k">def</span> <span class="nf">poke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        &#39;Poke&#39; the stimulator with an enable remote control command (only if currently connected).</span>
<span class="sd">        This should be used prior to any time-senstive commands, such as triggering the magstim to coincide with stimulus presentation. Conservatively, around 40-50ms should</span>
<span class="sd">        be enough time to allow for (~20ms if &#39;silently&#39; poking). This needs to be done to ensure that the ongoing communication with the magstim to maintain remote control</span>
<span class="sd">        does not interfere with the sent command. Note that this simply resets the timer controlling this ongoing communication (i.e., incrementing it a further 500 ms).</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        silent (bool): whether to bump polling robot but without sending enable remote control command (defaults to False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">silent</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_robotQueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_connectionCommand</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="Magstim.arm"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.arm">[docs]</a>    <span class="k">def</span> <span class="nf">arm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Arm the stimulator.</span>
<span class="sd">        </span>
<span class="sd">        N.B. You must allow at around 1 s for the stimulator to arm.</span>
<span class="sd">        </span>
<span class="sd">             If you send an arm() command when the Magstim is already armed, you will receive an non-fatal error reply from the Magstim that the command conflicts with the current settings.</span>
<span class="sd">             </span>
<span class="sd">             If the unit does not fire for more than 1 min while armed, it will disarm</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Magstim unit (defaults to False)</span>
<span class="sd">        delay (bool): enforce delay to allow Magstim time to arm (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a Magstim instrument status [&#39;instr&#39;] dict, otherwise returns an error string  </span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;EB&#39;</span><span class="p">,</span> <span class="s1">&#39;instr&#39;</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="c1">#Enforcing arming delay if requested</span>
        <span class="k">if</span> <span class="n">delay</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">1.1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Magstim.disarm"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.disarm">[docs]</a>    <span class="k">def</span> <span class="nf">disarm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Disarm the stimulator.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Magstim unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a Magstim instrument status [&#39;instr&#39;] dict, otherwise returns an error string   </span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;EA&#39;</span><span class="p">,</span> <span class="s1">&#39;instr&#39;</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="Magstim.isArmed"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.isArmed">[docs]</a>    <span class="k">def</span> <span class="nf">isArmed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Helper function that returns True if the Magstim is armed or ready, False if not or if it could not be determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span><span class="p">,</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queryCommand</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;instr&#39;</span><span class="p">][</span><span class="s1">&#39;armed&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;instr&#39;</span><span class="p">][</span><span class="s1">&#39;remoteStatus&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span> <span class="k">else</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Magstim.isUnderControl"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.isUnderControl">[docs]</a>    <span class="k">def</span> <span class="nf">isUnderControl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Helper function that returns True if the Magstim is under remote control, False if not or if it could not be determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span><span class="p">,</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queryCommand</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;instr&#39;</span><span class="p">][</span><span class="s1">&#39;remoteStatus&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span> <span class="k">else</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Magstim.isReadyToFire"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.isReadyToFire">[docs]</a>    <span class="k">def</span> <span class="nf">isReadyToFire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Helper function that returns True if the Magstim is ready to fire, False if not or if it could not be determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span><span class="p">,</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queryCommand</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;instr&#39;</span><span class="p">][</span><span class="s1">&#39;ready&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span> <span class="k">else</span> <span class="kc">False</span></div>
    
<div class="viewcode-block" id="Magstim.fire"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.fire">[docs]</a>    <span class="k">def</span> <span class="nf">fire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Fire the stimulator.</span>
<span class="sd">        </span>
<span class="sd">        N.B. Will only succeed if previously armed.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Magstim unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a Magstim instrument status [&#39;instr&#39;] dict, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;EH&#39;</span><span class="p">,</span> <span class="s1">&#39;instr&#39;</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Magstim.resetQuickFire"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.resetQuickFire">[docs]</a>    <span class="k">def</span> <span class="nf">resetQuickFire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Reset the RTS pin used for quick firing.</span>
<span class="sd">        </span>
<span class="sd">        N.B. There must be a few ms between triggering QuickFire and reseting the pin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendQueue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="Magstim.quickFire"><a class="viewcode-back" href="../../horizonmagpy.magstim.html#horizonmagpy.magstim.Magstim.quickFire">[docs]</a>    <span class="k">def</span> <span class="nf">quickFire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Trigger the stimulator to fire with very low latency using the RTS pin and a custom serial connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sendQueue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div></div>

<span class="k">class</span> <span class="nc">BiStim</span><span class="p">(</span><span class="n">Magstim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a sub-class of the parent Magstim class used for controlling BiStim^2 Magstim units. It allows firing in either BiStim mode or Simultaneous Discharge mode.</span>
<span class="sd">    </span>
<span class="sd">    To enable Simultaneous Discharge mode, you must change the pulseInterval parameter to 0 s (i.e., by calling: setPulseInterval(0)).</span>
<span class="sd">    </span>
<span class="sd">    N.B. In BiStim mode, the maximum firing frequency is 0.25 Hz. In Simulatenous Discharge mode, the maximum frequency depends on the power level (0.25 - 0.5 Hz)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialConnection</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BiStim</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">serialConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_highResolutionMode</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">highResolutionMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Enable/Disable high resolution timing of interpulse interval.</span>
<span class="sd">        When enabling high-resolution mode, the system will default to a 1ms interval.</span>
<span class="sd">        When disabling high-resolution mode, the system will default to a 10ms interval.</span>
<span class="sd">        N.B. This cannot be changed while the system is armed.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        enable (bool): whether to enable (True) or disable (False) high-resolution mode</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the BiStim unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a BiStim instrument status [&#39;instr&#39;] dict, otherwise returns an error strin</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span><span class="p">,</span><span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Y@&#39;</span> <span class="k">if</span> <span class="n">enable</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;Z@&#39;</span><span class="p">,</span> <span class="s1">&#39;instr&#39;</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_highResolutionMode</span> <span class="o">=</span> <span class="n">enable</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">getParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Request current coil temperature from the BiStim.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing BiStim instrument status [&#39;instr&#39;] and parameter setting [&#39;bistimParam&#39;] dicts, otherwise returns an error string   </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="n">message</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;J@&#39;</span><span class="p">,</span> <span class="s1">&#39;bistimParam&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highResolutionMode</span><span class="p">:</span>
            <span class="n">message</span><span class="p">[</span><span class="s1">&#39;bistimParam&#39;</span><span class="p">][</span><span class="s1">&#39;ppOffset&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">10.0</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">setPowerA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newPower</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set power level for BiStim A.</span>
<span class="sd">        </span>
<span class="sd">        N.B. Allow 100ms per unit drop in power, or 10ms per unit increase in power.</span>
<span class="sd">        </span>
<span class="sd">             In BiStim mode, power output is actually 90% of a 200^2 unit&#39;s power output. In Simulatenous Discharge mode (pulseInterval = 0), power output is actually 113% of a 200^2 unit&#39;s power output</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        newPower (int): new power level (0-100)</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the BiStim unit (defaults to False)</span>
<span class="sd">        delay (bool): enforce delay to allow BiStim time to change Power (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a BiStim instrument status [&#39;instr&#39;] dict, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#This is just an alias for the base magstim class method setPower</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">BiStim</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setPower</span><span class="p">(</span><span class="n">newPower</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="n">receipt</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span> <span class="n">_commandByte</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;@&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">setPowerB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newPower</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set power level for BiStim B.</span>
<span class="sd">        </span>
<span class="sd">        N.B. Allow 100ms per unit drop in power, or 10ms per unit increase in power.</span>
<span class="sd">        </span>
<span class="sd">             Power output is actually 90% of a 200^2 unit&#39;s power output.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        newPower (int): new power level (0-100)</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the BiStim unit (defaults to False)</span>
<span class="sd">        delay (bool): enforce delay to allow BiStim time to change Power (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a BiStim instrument status [&#39;instr&#39;] dict, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#This is just an alias for the base magstim class method setPower</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">BiStim</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setPower</span><span class="p">(</span><span class="n">newPower</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="n">receipt</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span> <span class="n">_commandByte</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">setPulseInterval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newInterval</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set interpulse interval.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        newInterval (int/float): new interpulse interval in milliseconds (Range low-resolution mode: 0-999; Range high-resolution mode: 0-99.9)</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the BiStim unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a BiStim instrument status [&#39;instr&#39;] dict, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we&#39;re in high resolution mode, then convert to tenths of a millisecond</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highResolutionMode</span><span class="p">:</span>
            <span class="n">newInterval</span> <span class="o">=</span> <span class="n">newInterval</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="c1"># Make sure we have a valid ipi value</span>
        <span class="k">if</span> <span class="n">newInterval</span> <span class="o">%</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_PRECISION_ERR</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highResolutionMode</span> <span class="k">else</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_FLOAT_ERR</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">newInterval</span> <span class="o">&lt;=</span> <span class="mi">999</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_RANGE_ERR</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;C&#39;</span> <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">newInterval</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="s1">&#39;instr&#39;</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">Rapid</span><span class="p">(</span><span class="n">Magstim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a sub-class of the parent Magstim class used for controlling Rapid^2 Magstim units. It allows firing in either single-pulse mode or rTMS mode.</span>
<span class="sd">    </span>
<span class="sd">    In single-pulse mode, the maximum firing frequency is 1 Hz (0.5 Hz if enhanced-power mode is enabled and power is 100 - 110%).</span>
<span class="sd">    </span>
<span class="sd">    To enable rTMS mode, you must first call rTMSMode(True). To disable rTMS mode, call rTMSMode(False).</span>
<span class="sd">    </span>
<span class="sd">    N.B. In rTMS mode the maximum frequency allowed is dependent on the power level. Also, there is a dependent relationship between the Duration, NPulses, and Frequency parameter settings.</span>
<span class="sd">         Therefore it is recommended either to seek confirmation of any change in settings or to evaluate allowable changes beforehand.</span>
<span class="sd">         </span>
<span class="sd">         In addition, after each rTMS train there is an enforced delay (minimum 500 ms) before any subsequent train can be initiated or before any rTMS parameter settings can be altered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load settings file (resort to default values if not found)</span>
    <span class="n">__location__</span> <span class="o">=</span> <span class="n">realpath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">__location__</span><span class="p">,</span> <span class="s1">&#39;rapid_config.yaml&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">yaml_file</span><span class="p">:</span>
            <span class="n">config_data</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">yaml_file</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">DEFAULT_RAPID_TYPE</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">DEFAULT_VOLTAGE</span> <span class="o">=</span> <span class="mi">240</span>
        <span class="n">DEFAULT_UNLOCK_CODE</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ENFORCE_ENERGY_SAFETY</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">DEFAULT_VIRTUAL_VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">DEFAULT_RAPID_TYPE</span> <span class="o">=</span> <span class="n">config_data</span><span class="p">[</span><span class="s1">&#39;defaultRapidType&#39;</span><span class="p">]</span>
        <span class="n">DEFAULT_VOLTAGE</span> <span class="o">=</span> <span class="n">config_data</span><span class="p">[</span><span class="s1">&#39;defaultVoltage&#39;</span><span class="p">]</span>
        <span class="n">DEFAULT_UNLOCK_CODE</span> <span class="o">=</span> <span class="n">config_data</span><span class="p">[</span><span class="s1">&#39;unlockCode&#39;</span><span class="p">]</span>
        <span class="n">ENFORCE_ENERGY_SAFETY</span> <span class="o">=</span> <span class="n">config_data</span><span class="p">[</span><span class="s1">&#39;enforceEnergySafety&#39;</span><span class="p">]</span>
        <span class="n">DEFAULT_VIRTUAL_VERSION</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">config_data</span><span class="p">[</span><span class="s1">&#39;virtualVersionNumber&#39;</span><span class="p">])</span>

    <span class="c1"># Load system info file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">__location__</span><span class="p">,</span> <span class="s1">&#39;rapid_system_info.yaml&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">yaml_file</span><span class="p">:</span>
        <span class="n">system_info</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">yaml_file</span><span class="p">)</span>
    <span class="c1"># Maximum allowed rTMS frequency based on voltage and current power setting</span>
    <span class="n">MAX_FREQUENCY</span> <span class="o">=</span> <span class="n">system_info</span><span class="p">[</span><span class="s1">&#39;maxFrequency&#39;</span><span class="p">]</span>
    <span class="c1"># Minimum wait time (s) required for rTMS train. Power:Joules per pulse</span>
    <span class="n">JOULES</span> <span class="o">=</span> <span class="n">system_info</span><span class="p">[</span><span class="s1">&#39;joules&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">getRapidMinWaitTime</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">nPulses</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate minimum wait time between trains for given power, frequency, and number of pulses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="n">nPulses</span> <span class="o">*</span> <span class="p">((</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">Rapid</span><span class="o">.</span><span class="n">JOULES</span><span class="p">[</span><span class="n">power</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1050.0</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1050.0</span> <span class="o">*</span> <span class="n">frequency</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">getRapidMaxOnTime</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate maximum train duration per minute for given power and frequency. If greater than 60 seconds, will allow for continuous operation for up to 6000 pulses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">63000.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">*</span> <span class="n">Rapid</span><span class="o">.</span><span class="n">JOULES</span><span class="p">[</span><span class="n">power</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">getRapidMaxContinuousOperationFrequency</span><span class="p">(</span><span class="n">power</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate maximum frequency that will allow for continuous operation (up to 6000 pulses).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">1050.0</span> <span class="o">/</span> <span class="n">Rapid</span><span class="o">.</span><span class="n">JOULES</span><span class="p">[</span><span class="n">power</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialConnection</span><span class="p">,</span> <span class="n">superRapid</span><span class="o">=</span><span class="n">DEFAULT_RAPID_TYPE</span><span class="p">,</span> <span class="n">unlockCode</span><span class="o">=</span><span class="n">DEFAULT_UNLOCK_CODE</span><span class="p">,</span> <span class="n">voltage</span><span class="o">=</span><span class="n">DEFAULT_VOLTAGE</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">DEFAULT_VIRTUAL_VERSION</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_super</span> <span class="o">=</span> <span class="n">superRapid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unlockCode</span> <span class="o">=</span> <span class="n">unlockCode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_voltage</span> <span class="o">=</span> <span class="n">voltage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">version</span> <span class="k">if</span> <span class="n">serialConnection</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;virtual&#39;</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Rapid</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">serialConnection</span><span class="p">)</span>
        <span class="c1"># If an unlock code has been supplied, then the Rapid requires a different command to stay in contact with it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unlockCode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connectionCommand</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;x@G&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queryCommand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSystemStatus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameterReturnBytes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repetitiveMode</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_setupSerialPort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialConnection</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">serialConnection</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;virtual&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">_virtual</span> <span class="kn">import</span> <span class="n">virtualPortController</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">virtualPortController</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_sendQueue</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_receiveQueue</span><span class="p">,</span><span class="n">superRapid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_super</span><span class="p">,</span><span class="n">unlockCode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_unlockCode</span><span class="p">,</span><span class="n">voltage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_voltage</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_version</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">serialPortController</span><span class="p">(</span><span class="n">serialConnection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sendQueue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receiveQueue</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Get Magstim software version number. This is needed when obtaining parameters from the Magstim.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        :tuple:(error,message):</span>
<span class="sd">            error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">            message (tuple): if error is 0 (False) returns a tuple containing the version number (in (Major,Minor,Patch) format), otherwise returns an error string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ND&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1">#If we didn&#39;t receive an error, update the version number and the number of bytes that will be returned by a getParameters() command</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">message</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parameterReturnBytes</span> <span class="o">=</span> <span class="mi">24</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parameterReturnBytes</span> <span class="o">=</span> <span class="mi">22</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parameterReturnBytes</span> <span class="o">=</span> <span class="mi">21</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getErrorCode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Get current error code from Rapid.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        :tuple:(error,message):</span>
<span class="sd">            error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">            message (dict,str): if error is 0 (False) returns a dict containing Rapid instrument status [&#39;instr&#39;] and current error code [&#39;errorCode&#39;] dicts, otherwise returns an error string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;I@&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Connect to the Rapid.</span>
<span class="sd">        </span>
<span class="sd">        This starts the serial port controller, as well as a process that constantly keeps in contact with the Rapid so as not to lose control.</span>
<span class="sd">        It also collects the software version number of the Rapid in order to send the correct command for obtaining parameter settings.</span>

<span class="sd">        Args:</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Rapid unit (defaults to False)</span>

<span class="sd">        Returns:</span>
<span class="sd">        :tuple:(error,message):</span>
<span class="sd">            error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">            message (str): if error is 0 (False) returns a string containing the version number (in (X,X,X) format), otherwise returns an error string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Rapid</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="c1"># We have to be able to determine the software version of the Rapid, otherwise we won&#39;t be able to communicate properly</span>
        <span class="n">error</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">MagstimError</span><span class="p">(</span><span class="s1">&#39;Could not determine software version of Rapid. Disconnecting.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Disconnect from the Magstim.</span>
<span class="sd">        </span>
<span class="sd">        This stops maintaining contact with the Magstim and turns the serial port controller off.</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="c1">#Just some housekeeping before we call the base magstim class method disconnect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repetitiveMode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Rapid</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rTMSMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">         This is a helper function to enable/disable rTMS mode.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        enable (bool): whether to enable (True) or disable (False) control</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Rapid unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing Rapid instrument status [&#39;instr&#39;] and rMTS setting [&#39;rapid&#39;] dicts, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span> <span class="o">=</span>  <span class="kc">False</span>
        <span class="c1"># Get current parameters</span>
        <span class="n">updateError</span><span class="p">,</span><span class="n">currentParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">updateError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_ACQUISTION_ERR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># See if Rapid already in rTMS mode (if enabling) or already in single-pulse mode (if disabling)</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapid&#39;</span><span class="p">][</span><span class="s1">&#39;singlePulseMode&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">enable</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapid&#39;</span><span class="p">][</span><span class="s1">&#39;singlePulseMode&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">enable</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">currentParameters</span><span class="p">)</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="c1"># Durations of 1 or 0 are used to toggle repetitive mode on and off</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,):</span>
                <span class="n">commandString</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;[0010&#39;</span> <span class="k">if</span> <span class="n">enable</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;[0000&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commandString</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;[010&#39;</span> <span class="k">if</span> <span class="n">enable</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;[000&#39;</span>
            <span class="n">error</span><span class="p">,</span><span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="n">commandString</span><span class="p">,</span> <span class="s1">&#39;instrRapid&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">enable</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_repetitiveMode</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">updateError</span><span class="p">,</span><span class="n">currentParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">updateError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">updateError</span><span class="p">,</span><span class="n">currentParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;B0010&#39;</span><span class="p">,</span> <span class="s1">&#39;instrRapid&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">updateError</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_UPDATE_ERR</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_ACQUISTION_ERR</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_repetitiveMode</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">ignoreCoilSafetySwitch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        This allows the stimulator to ignore the state of coil safety interlock switch.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Rapid unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing Rapid instrument status [&#39;instr&#39;] dict, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;b@&#39;</span><span class="p">,</span> <span class="s1">&#39;instr&#39;</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remoteControl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Enable/Disable remote control of stimulator. Disabling remote control will first disarm the Magstim unit.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        enable (bool): whether to enable (True) or disable (False) control</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Magstim unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a Magstim instrument status [&#39;instr&#39;] dict, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unlockCode</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Q&#39;</span> <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unlockCode</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin_1&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">enable</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;R@&#39;</span><span class="p">,</span> <span class="s1">&#39;instr&#39;</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Q@&#39;</span> <span class="k">if</span> <span class="n">enable</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;R@&#39;</span><span class="p">,</span> <span class="s1">&#39;instr&#39;</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">enhancedPowerMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Enable/Disable enhanced power mode; allowing intensity to be set to 110%.</span>
<span class="sd">        </span>
<span class="sd">        N.B. This can only be enabled in single-pulse mode, and lowers the maximum firing frequency to 0.5 Hz.</span>

<span class="sd">             Disabling will automatically reduce intensity to 100% if over</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        enable (bool): whether to enable (True) or disable (False) enhanced-power mode</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Rapid unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing Rapid instrument status [&#39;instr&#39;] and rMTS setting [&#39;rapid&#39;] dicts, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;^@&#39;</span> <span class="k">if</span> <span class="n">enable</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;_@&#39;</span><span class="p">,</span> <span class="s1">&#39;instrRapid&#39;</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isEnhanced</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Helper function that returns True if the Rapid is in enhanced power mode, False if not if it could not be determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span><span class="p">,</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queryCommand</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rapid&#39;</span><span class="p">][</span><span class="s1">&#39;enhancedPowerMode&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span> <span class="k">else</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">setFrequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newFrequency</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set frequency of rTMS pulse train.</span>
<span class="sd">        </span>
<span class="sd">        N.B. Changing the Frequency will automatically update the NPulses parameter based on the current Duration parameter setting.</span>
<span class="sd">        </span>
<span class="sd">             The maximum frequency allowed depends on the current Power level and the regional power settings (i.e., 115V vs. 240V)</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        newFrequency (int/float): new frequency of pulse train in Hertz (0-100 for 240V systems, 0-60 for 115V systems); decimal values are allowed for frequencies up to 30Hz</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Rapid unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing Rapid instrument status [&#39;instr&#39;] and rMTS setting [&#39;rapid&#39;] dicts, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span> <span class="o">=</span>  <span class="kc">False</span>

        <span class="c1"># Convert to tenths of a Hz</span>
        <span class="n">newFrequency</span> <span class="o">=</span> <span class="n">newFrequency</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="c1"># Make sure we have a valid frequency value</span>
        <span class="k">if</span> <span class="n">newFrequency</span> <span class="o">%</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_PRECISION_ERR</span>
        <span class="n">updateError</span><span class="p">,</span><span class="n">currentParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">updateError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_ACQUISTION_ERR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxFrequency</span> <span class="o">=</span> <span class="n">Rapid</span><span class="o">.</span><span class="n">MAX_FREQUENCY</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_voltage</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_super</span><span class="p">][</span><span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;power&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">10</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">newFrequency</span> <span class="o">&lt;=</span> <span class="n">maxFrequency</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_RANGE_ERR</span>

        <span class="c1">#Send command</span>
        <span class="n">error</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span> <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">newFrequency</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="s1">&#39;instrRapid&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> 
        <span class="c1">#If we didn&#39;t get an error, update the other parameters accordingly</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">updateError</span><span class="p">,</span><span class="n">currentParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">updateError</span><span class="p">:</span>
                <span class="n">updateError</span><span class="p">,</span><span class="n">currentParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;D&#39;</span> <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;frequency&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,)</span> <span class="k">else</span> <span class="mi">4</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="s1">&#39;instrRapid&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">updateError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_UPDATE_ERR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_ACQUISTION_ERR</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">setNPulses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newNPulses</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set number of pulses in rTMS pulse train.</span>
<span class="sd">        </span>
<span class="sd">        N.B. Changing the NPulses parameter will automatically update the Duration parameter (this cannot exceed 10 s) based on the current Frequency parameter setting.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        newNPulses (int): new number of pulses (Version 9+: 1-6000; Version 7+: ?; Version 5+: 1-1000?)</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Rapid unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing Rapid instrument status [&#39;instr&#39;] and rMTS setting [&#39;rapid&#39;] dicts, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span> <span class="o">=</span>  <span class="kc">False</span>

        <span class="c1"># Make sure we have a valid number of pulses value</span>
        <span class="k">if</span> <span class="n">newNPulses</span> <span class="o">%</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_FLOAT_ERR</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">newNPulses</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_RANGE_ERR</span>

        <span class="c1">#Send command</span>
        <span class="n">error</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;D&#39;</span> <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">newNPulses</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,)</span> <span class="k">else</span> <span class="mi">4</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="s1">&#39;instrRapid&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="c1">#If we didn&#39;t get an error, update the other parameters accordingly</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">updateError</span><span class="p">,</span> <span class="n">currentParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">updateError</span><span class="p">:</span>
                <span class="n">updateError</span><span class="p">,</span> <span class="n">currentParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;nPulses&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;frequency&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,)</span> <span class="k">else</span> <span class="mi">3</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="s1">&#39;instrRapid&#39;</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">updateError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_UPDATE_ERR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_ACQUISTION_ERR</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">setDuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newDuration</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set duration of rTMS pulse train.</span>
<span class="sd">        </span>
<span class="sd">        N.B. Changing the Duration parameter will automatically update the NPulses parameter based on the current Frequency parameter setting.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        newDuration (int/float): new duration of pulse train in seconds (Version 9+: 1-600; Version 7+: ?; Version 5+: 1-10?); decimal values are allowed for durations up to 30s</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Rapid unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing Rapid instrument status [&#39;instr&#39;] and rMTS setting [&#39;rapid&#39;] dicts, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span> <span class="o">=</span>  <span class="kc">False</span>

        <span class="c1"># Convert to tenths of a second</span>
        <span class="n">newDuration</span> <span class="o">=</span> <span class="n">newDuration</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="c1"># Make sure we have a valid duration value</span>
        <span class="k">if</span> <span class="n">newDuration</span> <span class="o">%</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_PRECISION_ERR</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">newDuration</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">999</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">9</span><span class="p">,)</span> <span class="k">else</span> <span class="mi">9999</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_RANGE_ERR</span>

        <span class="n">error</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">newDuration</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,)</span> <span class="k">else</span> <span class="mi">3</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="s1">&#39;instrRapid&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">updateError</span><span class="p">,</span> <span class="n">currentParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">updateError</span><span class="p">:</span>
                <span class="n">updateError</span><span class="p">,</span> <span class="n">currentParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;D&#39;</span> <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;frequency&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,)</span> <span class="k">else</span> <span class="mi">4</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="s1">&#39;instrRapid&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">updateError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_UPDATE_ERR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_ACQUISTION_ERR</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">getParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Request current parameter settings from the Rapid.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        :tuple:(error,message):</span>
<span class="sd">            error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">            message (dict,str): if error is 0 (False) returns a dict containing Rapid instrument status [&#39;instr&#39;], rMTS setting [&#39;rapid&#39;], and parameter setting [&#39;rapidParam&#39;] dicts, otherwise returns an error string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">@&#39;</span><span class="p">,</span> <span class="s1">&#39;rapidParam&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameterReturnBytes</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">setPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newPower</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set power level for the Rapid.</span>
<span class="sd">        </span>
<span class="sd">        N.B. Allow 100 ms per unit drop in power, or 10 ms per unit increase in power.</span>
<span class="sd">        </span>
<span class="sd">             Changing the power level can result in automatic updating of the Frequency parameter (if in rTMS mode)</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        newPower (int): new power level (0-100; or 0-110 if enhanced-power mode is enabled)</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Rapid unit (defaults to False)</span>
<span class="sd">        delay (bool): enforce delay to allow Rapid time to change Power (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a Rapid instrument status [&#39;instr&#39;] dict, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span> <span class="o">=</span>  <span class="kc">False</span>

        <span class="c1"># Check current enhanced power status</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isEnhanced</span><span class="p">():</span>
            <span class="n">maxPower</span> <span class="o">=</span> <span class="mi">110</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxPower</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="c1"># Make sure we have a valid power value</span>
        <span class="k">if</span> <span class="n">newPower</span> <span class="o">%</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_FLOAT_ERR</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">newPower</span> <span class="o">&lt;=</span> <span class="n">maxPower</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_RANGE_ERR</span>
        
        <span class="n">error</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Rapid</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setPower</span><span class="p">(</span><span class="n">newPower</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">delay</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;@&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">updateError</span><span class="p">,</span> <span class="n">currentParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">updateError</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapid&#39;</span><span class="p">][</span><span class="s1">&#39;singlePulseMode&#39;</span><span class="p">]:</span>
                    <span class="n">maxFrequency</span> <span class="o">=</span> <span class="n">Rapid</span><span class="o">.</span><span class="n">MAX_FREQUENCY</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_voltage</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_super</span><span class="p">][</span><span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;power&#39;</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">currentParameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxFrequency</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setFrequency</span><span class="p">(</span><span class="n">maxFrequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_UPDATE_ERR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_ACQUISTION_ERR</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">setChargeDelay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newDelay</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set charge delay duration for the Rapid.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        newDelay (int): new delay duration in seconds (Version 10+: 1-10000; Version 9: 1-2000)</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Rapid unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a Rapid instrument status [&#39;instr&#39;] dict, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">GET_SYSTEM_STATUS_ERR</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">9</span><span class="p">,):</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">SYSTEM_STATUS_VERSION_ERR</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span> <span class="o">=</span>  <span class="kc">False</span>
            
        <span class="c1">#Make sure we have a valid delay duration value</span>
        <span class="k">if</span> <span class="n">newDelay</span> <span class="o">%</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_FLOAT_ERR</span>

        <span class="n">error</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;n&#39;</span> <span class="o">+</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">newDelay</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,)</span> <span class="k">else</span> <span class="mi">4</span><span class="p">),</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="s1">&#39;systemRapid&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,)</span> <span class="k">else</span> <span class="s1">&#39;instrRapid&#39;</span><span class="p">,</span> <span class="mi">6</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,)</span> <span class="k">else</span> <span class="mi">4</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="n">receipt</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">getChargeDelay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Get current charge delay duration for the Rapid.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a Rapid instrument status [&#39;instr&#39;] dict and charge delay duration [&#39;chargeDelay&#39;] value, otherwise returns an error string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">GET_SYSTEM_STATUS_ERR</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">9</span><span class="p">,):</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">SYSTEM_STATUS_VERSION_ERR</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;o@&#39;</span><span class="p">,</span> <span class="s1">&#39;instrCharge&#39;</span><span class="p">,</span> <span class="mi">8</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">9</span><span class="p">,)</span> <span class="k">else</span> <span class="mi">7</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Fire the stimulator. This overrides the base Magstim method in order to check whether rTMS mode is active, and if so whether the sequence has been validated and the min wait time between trains has elapsed</span>
<span class="sd">        </span>
<span class="sd">        N.B. Will only succeed if previously armed.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">        receipt (bool): whether to return occurrence of an error and the automated response from the Magstim unit (defaults to False)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        If receipt argument is True:</span>
<span class="sd">            :tuple:(error,message):</span>
<span class="sd">                error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">                message (dict,str): if error is 0 (False) returns a dict containing a Magstim instrument status [&#39;instr&#39;] dict, otherwise returns an error string</span>
<span class="sd">        If receipt argument is False:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repetitiveMode</span> <span class="ow">and</span> <span class="n">Rapid</span><span class="o">.</span><span class="n">ENFORCE_ENERGY_SAFETY</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">SEQUENCE_VALIDATION_ERR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Rapid</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">receipt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">quickFire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Trigger the stimulator to fire with very low latency using the RTS pin and a custom serial connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repetitiveMode</span> <span class="ow">and</span> <span class="n">Rapid</span><span class="o">.</span><span class="n">ENFORCE_ENERGY_SAFETY</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">SEQUENCE_VALIDATION_ERR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Rapid</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">quickFire</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">validateSequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Validate the energy consumption for the current rTMS parameters for the Rapid.</span>
<span class="sd">        This must be performed before running any new sequence, otherwise calling fire() will return an error.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        :tuple:(error,message):</span>
<span class="sd">            error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">            message (dict,str): if error is 0 (False) returns current Rapid parameters, otherwise returns an error string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">error</span><span class="p">,</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">PARAMETER_ACQUISTION_ERR</span>
        <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">],</span> <span class="mi">60</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Rapid</span><span class="o">.</span><span class="n">getRapidMaxOnTime</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;power&#39;</span><span class="p">],</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rapidParam&#39;</span><span class="p">][</span><span class="s1">&#39;frequency&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">MAX_ON_TIME_ERR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequenceValidated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getSystemStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Get system status from the Rapid. Available only on software version of 9 or later.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        :tuple:(error,message):</span>
<span class="sd">            error (int): error code (0 = no error; 1+ = error)</span>
<span class="sd">            message (dict,str): if error is 0 (False) returns a dict containing Rapid instrument status [&#39;instr&#39;], rMTS setting [&#39;rapid&#39;], and extended instrument status [&#39;extInstr&#39;] dicts, otherwise returns an error string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">GET_SYSTEM_STATUS_ERR</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processCommand</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;x@&#39;</span><span class="p">,</span> <span class="s1">&#39;systemRapid&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Magstim</span><span class="o">.</span><span class="n">SYSTEM_STATUS_VERSION_ERR</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Ricarda Staehle.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>